
# GAMES101 课程笔记：光栅化 (Rasterization)
**Lecture 5 & 6**

## 第一部分：从几何到屏幕 (Lecture 5)

### 1. 视口变换 (Viewport Transformation)
在经过 MVP（模型 Model、视图 View、投影 Projection）变换后，物体被压缩在一个 $[-1, 1]^3$ 的**标准立方体 (Canonical Cube)** 中。下一步是将这个立方体映射到屏幕空间。

*   **屏幕的定义**：
    *   一个二维数组，由像素 (Pixels) 组成。
    *   数组的大小被称为**分辨率 (Resolution)** (例如 $1920 \times 1080$)。
    *   **像素 (Pixel)**：在这个阶段，我们将像素抽象为一个颜色均匀的小方块，颜色由 RGB 混合而成。(Pixel = Picture Element)。
*   **坐标映射**：
    *   屏幕空间坐标范围：$(0, 0)$ 到 $(width, height)$。
    *   像素索引：$(x, y)$，其中 $x \in [0, width-1], y \in [0, height-1]$，且均为整数。
    *   **像素中心**：约定像素 $(x, y)$ 的中心位于 $(x + 0.5, y + 0.5)$。
    *   **变换公式**：将 $[-1, 1]^2$ 的 $xy$ 平面拉伸并平移到 $[0, width] \times [0, height]$。暂不考虑 $z$ 轴（深度）。
    
    $$
    M_{viewport} = \begin{pmatrix} 
    \frac{width}{2} & 0 & 0 & \frac{width}{2} \\
    0 & \frac{height}{2} & 0 & \frac{height}{2} \\
    0 & 0 & 1 & 0 \\
    0 & 0 & 0 & 1 
    \end{pmatrix}
    $$

### 2. 光栅化 (Rasterization) 基础
光栅化的核心目标是将连续的几何图形（Triangles）转化为离散的像素点（Pixels）。

*   **为什么选择三角形？**
    *   最基础的多边形，任何多边形都可以拆分为三角形。
    *   性质独特：保证平面性（三个点确定一个平面）、内部定义清晰。
    *   易于进行插值（重心坐标插值）。
*   **采样 (Sampling)**：
    *   光栅化本质上就是**采样**。
    *   **采样的定义**：在特定的函数（或图像）上，计算其在某一点的值。
    *   **过程**：我们要判断像素的中心点是否在三角形内部。

### 3. 判断点在三角形内 (Point-in-Triangle Test)
这是光栅化最核心的算法。
*   **利用叉积 (Cross Product)**：
    *   给定三角形三个顶点 $P_0, P_1, P_2$ 和测试点 $Q$。
    *   按照逆时针（或顺时针）顺序，计算向量叉积：$\vec{P_0P_1} \times \vec{P_0Q}$，$\vec{P_1P_2} \times \vec{P_1Q}$，$\vec{P_2P_0} \times \vec{P_2Q}$。
    *   如果这三个叉积结果的 $z$ 分量符号相同（全为正或全为负），则点 $Q$ 在三角形内部。
*   **边界情况 (Edge Cases)**：如果点正好落在三角形边上，自行定义处理方式（通常由图形API决定，例如OpenGL规定若点在左边或上边则算入）。
*   **包围盒优化 (Bounding Box / AABB)**：
    *   不需要遍历屏幕上所有像素。
    *   只需遍历三角形的包围盒（$x_{min}$ 到 $x_{max}$, $y_{min}$ 到 $y_{max}$）内的像素即可。

---

## 第二部分：采样伪影与信号处理 (Lecture 6)

### 1. 采样带来的问题 (Artifacts)
简单的中心点采样会产生各种**走样 (Aliasing)** 现象：
*   **锯齿 (Jaggies)**：空间上的采样产生的锯齿状边缘。
*   **摩尔纹 (Moiré Patterns)**：去掉图像的奇数行/列时产生的奇怪纹理。
*   **车轮效应 (Wagon Wheel Effect)**：时间上的采样（视频）导致高速旋转的车轮看起来像在倒转。

**本质原因**：信号变化太快（高频），而采样速度太慢。

### 2. 频域分析 (Frequency Domain Analysis)
为了理解走样，需要引入信号处理的基础：
*   **傅里叶变换 (Fourier Transform)**：任何周期函数都可以分解为不同频率的正弦和余弦函数的加权和。它可以将信号从**时域/空域 (Spatial Domain)** 转换到**频域 (Frequency Domain)**。
*   **滤波 (Filtering)**：
    *   **高通滤波 (High-pass)**：只保留高频信号 $\rightarrow$ 提取图像的**边缘**（变化剧烈的地方）。
    *   **低通滤波 (Low-pass)**：只保留低频信号 $\rightarrow$ 图像变**模糊**。
*   **卷积 (Convolution)**：
    *   **卷积定理**：时域（空域）上的**卷积**等于频域上的**乘积**。
    *   例如：在图像上用一个 $3 \times 3$ 的平均权重窗口滑动（卷积），相当于在频域上乘以一个低通滤波器（Box Filter 对应 sinc 函数），结果就是图像变模糊。

### 3. 走样的本质 (The Nature of Aliasing)
*   **采样定理**：
    *   在频域上，**采样 (Sampling)** 等同于将原始信号的频谱进行**周期性重复 (Repeating)**。
    *   **采样越稀疏**（采样率低），频域上复制的频谱之间的**距离越近**。
*   **混叠 (Aliasing)**：
    *   如果采样率不足（低于奈奎斯特频率），复制后的频谱会发生**重叠 (Overlapping)**。
    *   高频信号“假装”成了低频信号，导致走样。

---

## 第三部分：反走样 (Antialiasing)

### 1. 反走样的思路
既然走样是因为频谱重叠，那么解决思路有两种：
1.  **提高采样率**：使用超高分辨率显示器（物理上增加采样点）。但成本高，且无法彻底解决。
2.  **先模糊，再采样 (Pre-Filtering)**：
    *   **原理**：在采样之前，先用低通滤波器（如把三角形边缘模糊化）把高频信号“切掉”。
    *   **结果**：频谱变窄了，再进行复制（采样）时，就不会发生重叠。
    *   **顺序至关重要**：必须是**先模糊再采样**。如果先采样再模糊，那就是把已经产生的错误（锯齿）给模糊了，无法去除走样。

### 2. MSAA (Multisample Anti-Aliasing)
MSAA 是对“先模糊再采样”的一种近似实现，它不提高物理分辨率，但在一个像素内部进行多次采样。

*   **步骤**：
    1.  将每个像素逻辑上划分为 $N \times N$ 个**子像素 (Sub-pixels)**（例如 $2 \times 2 = 4$ 个）。
    2.  对每个子像素的中心点进行“在三角形内”的测试。
    3.  统计一个像素内有多少个子像素被三角形覆盖。
    4.  **平均化**：根据覆盖比例计算该像素的颜色。例如，如果 $2 \times 2$ 的子像素中有 3 个被覆盖，那么该像素颜色 = 三角形颜色 $\times 75\%$ + 背景色 $\times 25\%$。
*   **效果**：像素边缘不再是非 0 即 1 的硬切，而是有了中间过渡色，视觉上看起来更平滑（模糊了边缘）。
*   **代价**：计算量增加。虽然像素着色（Shading）通常只算一次，但几何覆盖测试（Rasterization）要做 $N^2$ 次。

### 3. 其他抗锯齿技术 (简述)
*   **FXAA (Fast Approximate AA)**：后处理技术。先得到有锯齿的图，通过图像识别找到边缘，然后把边缘模糊掉。速度极快。
*   **TAA (Temporal AA)**：利用上一帧的信息。将采样点在时间上进行复用，相当于把MSAA的样本分布在时间轴上。
*   **DLSS (Deep Learning Super Sampling)**：利用深度学习，把低分辨率图像“猜”成高分辨率图像，同时补充细节并去除锯齿。

---

### 总结 (Summary)
1.  **光栅化**是将连续几何转化为离散像素的过程。
2.  最简单的光栅化方法是**中心点采样**，判断像素中心是否在三角形内。
3.  采样过疏会导致**走样 (Aliasing)**，表现为锯齿。
4.  从频域看，走样是频谱混叠造成的。
5.  **反走样 (Antialiasing)** 的核心是：在采样前先滤除高频信号（模糊）。
6.  **MSAA** 通过在像素内增加采样点来近似计算覆盖率，从而实现反走样。